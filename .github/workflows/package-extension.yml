name: Package Easy-Keys Extension

on:
  push:
    branches:
      - master

jobs:
  package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate manifest.json
        run: |
          echo "üîç V√©rification du manifest.json..."
          MANIFEST_PATH="manifest.json"

          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "‚ùå Fichier manifest.json introuvable √† : $MANIFEST_PATH"
            exit 1
          fi

          # V√©rifie que c‚Äôest un JSON valide
          jq empty "$MANIFEST_PATH" || (echo "‚ùå manifest.json invalide (erreur JSON)" && exit 1)

          # V√©rifie que les champs essentiels existent
          for field in name version manifest_version; do
            if ! jq -e ".$field" "$MANIFEST_PATH" > /dev/null; then
              echo "‚ùå Champ manquant dans manifest.json : $field"
              exit 1
            fi
          done

          echo "‚úÖ manifest.json valide !"

      - name: Create build directory
        run: mkdir -p dist

      - name: Create ZIP package
        run: |
          zip -r ../dist/Easy-Keys.zip ./*

      - name: Upload packaged extension as artifact
        uses: actions/upload-artifact@v4
        with:
          name: easy-keys-package
          path: dist/Easy-Keys.zip

      - name: Create GitHub Release (optional)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/Easy-Keys.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
